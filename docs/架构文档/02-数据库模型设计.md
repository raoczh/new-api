# New API 数据库模型设计

## 数据库架构概览

### 支持的数据库

- **SQLite**: 默认数据库，适合小规模部署
- **MySQL**: ≥ 5.7.8，适合中大规模部署
- **PostgreSQL**: ≥ 9.6，适合大规模部署

### 数据库连接配置

```bash
# 主数据库
SQL_DSN=postgres://user:pass@host:5432/dbname  # PostgreSQL
SQL_DSN=user:pass@tcp(host:3306)/dbname        # MySQL
SQL_DSN=local                                   # SQLite (默认)

# 日志数据库（可选，分离日志提升性能）
LOG_SQL_DSN=postgres://user:pass@host:5432/logdb
```

## 核心数据模型

### 1. User (用户表)

用户账户信息和配额管理。

```go
type User struct {
    Id               int            // 用户ID
    Username         string         // 用户名（唯一）
    Password         string         // 密码哈希
    DisplayName      string         // 显示名称
    Role             int            // 角色：1=普通用户, 10=管理员, 100=超级管理员
    Status           int            // 状态：1=启用, 2=禁用
    Email            string         // 邮箱

    // OAuth 绑定
    GitHubId         string         // GitHub ID
    DiscordId        string         // Discord ID
    OidcId           string         // OIDC ID
    WeChatId         string         // 微信 ID
    TelegramId       string         // Telegram ID
    LinuxDOId        string         // LinuxDO ID

    // 令牌和配额
    AccessToken      *string        // 系统管理令牌（32字符）
    Quota            int            // 剩余配额
    UsedQuota        int            // 已使用配额
    RequestCount     int            // 请求次数

    // 分组和邀请
    Group            string         // 用户分组（default）
    AffCode          string         // 邀请码（唯一）
    AffCount         int            // 邀请人数
    AffQuota         int            // 邀请剩余额度
    AffHistoryQuota  int            // 邀请历史额度
    InviterId        int            // 邀请人ID

    // 其他
    Setting          string         // 用户设置（JSON）
    Remark           string         // 备注
    StripeCustomer   string         // Stripe 客户ID
    DeletedAt        gorm.DeletedAt // 软删除
}
```

**索引**:
- `username` (唯一索引)
- `display_name` (索引)
- `email` (索引)
- `github_id`, `discord_id`, `oidc_id`, `wechat_id`, `telegram_id`, `linux_do_id` (索引)
- `access_token` (唯一索引)
- `aff_code` (唯一索引)
- `inviter_id` (索引)
- `stripe_customer` (索引)

**关系**:
- 一对多: User → Token (一个用户可以有多个令牌)
- 一对多: User → Log (一个用户有多条日志)
- 一对多: User → UserSubscription (一个用户有多个订阅)

### 2. Token (令牌表)

API 访问令牌，用于客户端调用 API。

```go
type Token struct {
    Id                 int            // 令牌ID
    UserId             int            // 所属用户ID
    Key                string         // 令牌密钥（48字符，唯一）
    Status             int            // 状态：1=启用, 2=禁用
    Name               string         // 令牌名称
    CreatedTime        int64          // 创建时间（Unix时间戳）
    AccessedTime       int64          // 最后访问时间
    ExpiredTime        int64          // 过期时间（-1=永不过期）

    // 配额管理
    RemainQuota        int            // 剩余配额
    UnlimitedQuota     bool           // 无限配额
    UsedQuota          int            // 已使用配额

    // 模型限制
    ModelLimitsEnabled bool           // 是否启用模型限制
    ModelLimits        string         // 模型限制列表（逗号分隔）

    // 访问控制
    AllowIps           *string        // IP白名单（换行分隔）
    Group              string         // 分组
    CrossGroupRetry    bool           // 跨分组重试（仅auto分组）

    DeletedAt          gorm.DeletedAt // 软删除
}
```

**索引**:
- `user_id` (索引)
- `key` (唯一索引)
- `name` (索引)

**关系**:
- 多对一: Token → User

### 3. Channel (渠道表)

上游 AI 提供商渠道配置。

```go
type Channel struct {
    Id                 int            // 渠道ID
    Type               int            // 渠道类型（1=OpenAI, 2=Claude等）
    Key                string         // API密钥（支持多Key，换行分隔）
    OpenAIOrganization *string        // OpenAI组织ID
    TestModel          *string        // 测试模型
    Status             int            // 状态：1=启用, 2=禁用, 3=自动禁用
    Name               string         // 渠道名称
    Weight             *uint          // 权重（用于负载均衡）
    CreatedTime        int64          // 创建时间
    TestTime           int64          // 测试时间
    ResponseTime       int            // 响应时间（毫秒）

    // 连接配置
    BaseURL            *string        // 自定义API地址
    Other              string         // 其他配置（如API版本）

    // 余额和使用
    Balance            float64        // 余额（美元）
    BalanceUpdatedTime int64          // 余额更新时间
    UsedQuota          int64          // 已使用配额

    // 模型和分组
    Models             string         // 支持的模型列表
    Group              string         // 分组（default）

    // 高级配置
    ModelMapping       *string        // 模型映射（JSON）
    StatusCodeMapping  *string        // 状态码映射（JSON）
    Priority           *int64         // 优先级
    AutoBan            *int           // 自动禁用：1=启用, 0=禁用
    OtherInfo          string         // 其他信息
    Tag                *string        // 标签
    Setting            *string        // 渠道额外设置（JSON）
    ParamOverride      *string        // 参数覆盖（JSON）
    HeaderOverride     *string        // 请求头覆盖（JSON）
    Remark             *string        // 备注

    // 多Key信息
    ChannelInfo        ChannelInfo    // 多Key管理信息（JSON）
    OtherSettings      string         // 其他设置（JSON）

    // 缓存字段（不存储）
    Keys               []string       `gorm:"-"` // 解析后的Key列表
}

type ChannelInfo struct {
    IsMultiKey             bool                  // 是否多Key模式
    MultiKeySize           int                   // Key数量
    MultiKeyStatusList     map[int]int           // Key状态列表
    MultiKeyDisabledReason map[int]string        // Key禁用原因
    MultiKeyDisabledTime   map[int]int64         // Key禁用时间
    MultiKeyPollingIndex   int                   // 轮询索引
    MultiKeyMode           constant.MultiKeyMode // 模式：轮询/随机
}
```

**索引**:
- `name` (索引)
- `tag` (索引)

**关系**:
- 一对多: Channel → Log (一个渠道有多条日志)

### 4. Log (使用日志表)

API 调用日志，记录每次请求的详细信息。

```go
type Log struct {
    Id               int            // 日志ID
    UserId           int            // 用户ID
    CreatedAt        int64          // 创建时间
    Type             int            // 类型：1=充值, 2=消费, 3=管理, 4=系统
    Content          string         // 内容描述
    Username         string         // 用户名
    TokenName        string         // 令牌名称
    ModelName        string         // 模型名称
    Quota            int            // 配额变化
    PromptTokens     int            // 输入Token数
    CompletionTokens int            // 输出Token数
    ChannelId        *int           // 渠道ID
    ChannelName      *string        // 渠道名称
    RequestId        string         // 请求ID
    UseTime          int            // 使用时间（毫秒）
    Group            string         // 分组
}
```

**索引**:
- `user_id` (索引)
- `created_at` (索引)
- `channel_id` (索引)
- `request_id` (索引)

**注意**: 日志表可以配置独立数据库（LOG_SQL_DSN）以提升性能。

### 5. Model (模型表)

AI 模型配置和定价信息。

```go
type Model struct {
    Id              int            // 模型ID
    Name            string         // 模型名称（唯一）
    VendorId        *int           // 供应商ID
    Enabled         bool           // 是否启用
    EndpointTypes   string         // 端点类型（JSON数组）
    Tags            string         // 标签（JSON数组）
    Description     string         // 描述
    ContextLength   int            // 上下文长度
    MaxOutputTokens int            // 最大输出Token
    Pricing         string         // 定价信息（JSON）
    CreatedAt       int64          // 创建时间
    UpdatedAt       int64          // 更新时间
}
```

**索引**:
- `name` (唯一索引)
- `vendor_id` (索引)

### 6. Vendor (供应商表)

AI 提供商信息。

```go
type Vendor struct {
    Id          int            // 供应商ID
    Name        string         // 供应商名称（唯一）
    DisplayName string         // 显示名称
    Description string         // 描述
    Website     string         // 官网
    Logo        string         // Logo URL
    Enabled     bool           // 是否启用
    CreatedAt   int64          // 创建时间
    UpdatedAt   int64          // 更新时间
}
```

### 7. Subscription (订阅相关表)

#### SubscriptionPlan (订阅计划)

```go
type SubscriptionPlan struct {
    Id                      int            // 计划ID
    Title                   string         // 标题
    Subtitle                string         // 副标题
    PriceAmount             decimal.Decimal // 价格（精确到6位小数）
    Currency                string         // 货币（USD）
    DurationUnit            string         // 时长单位（month/year/custom）
    DurationValue           int            // 时长值
    CustomSeconds           int64          // 自定义秒数
    Enabled                 bool           // 是否启用
    SortOrder               int            // 排序
    StripePriceId           string         // Stripe价格ID
    CreemProductId          string         // Creem产品ID
    MaxPurchasePerUser      int            // 每用户最大购买次数
    UpgradeGroup            string         // 升级组
    TotalAmount             int64          // 总配额
    QuotaResetPeriod        string         // 配额重置周期
    QuotaResetCustomSeconds int64          // 自定义重置秒数
    CreatedAt               int64          // 创建时间
    UpdatedAt               int64          // 更新时间
}
```

#### UserSubscription (用户订阅)

```go
type UserSubscription struct {
    Id                int            // 订阅ID
    UserId            int            // 用户ID
    PlanId            int            // 计划ID
    Status            string         // 状态：active/expired/cancelled
    StartTime         int64          // 开始时间
    EndTime           int64          // 结束时间
    TotalAmount       int64          // 总配额
    UsedAmount        int64          // 已使用配额
    RemainingAmount   int64          // 剩余配额
    QuotaResetPeriod  string         // 配额重置周期
    LastResetTime     int64          // 上次重置时间
    NextResetTime     int64          // 下次重置时间
    CreatedAt         int64          // 创建时间
    UpdatedAt         int64          // 更新时间
}
```

#### SubscriptionOrder (订阅订单)

```go
type SubscriptionOrder struct {
    Id              int            // 订单ID
    UserId          int            // 用户ID
    PlanId          int            // 计划ID
    Amount          decimal.Decimal // 金额
    Currency        string         // 货币
    Status          string         // 状态：pending/paid/failed/refunded
    PaymentMethod   string         // 支付方式
    PaymentId       string         // 支付ID
    CreatedAt       int64          // 创建时间
    UpdatedAt       int64          // 更新时间
}
```

### 8. Task (任务表)

异步任务管理（Midjourney、Suno等）。

```go
type Task struct {
    Id              int            // 任务ID
    UserId          int            // 用户ID
    Platform        string         // 平台：midjourney/suno
    Action          string         // 动作：imagine/upscale/vary等
    Status          string         // 状态：pending/running/success/failed
    SubmitTime      int64          // 提交时间
    StartTime       int64          // 开始时间
    FinishTime      int64          // 完成时间
    Progress        string         // 进度
    PromptEn        string         // 英文提示词
    Prompt          string         // 原始提示词
    FailReason      string         // 失败原因
    ImageUrl        string         // 结果图片URL
    TaskId          string         // 任务ID（外部）
    ChannelId       int            // 渠道ID
    Quota           int            // 消耗配额
}
```

### 9. Midjourney (Midjourney任务表)

专门用于 Midjourney 任务管理。

```go
type Midjourney struct {
    Id              int            // 任务ID
    UserId          int            // 用户ID
    Code            int            // 状态码
    MjId            string         // MJ任务ID
    Action          string         // 动作
    Status          string         // 状态
    SubmitTime      int64          // 提交时间
    StartTime       int64          // 开始时间
    FinishTime      int64          // 完成时间
    Progress        string         // 进度
    PromptEn        string         // 英文提示词
    Prompt          string         // 原始提示词
    FailReason      string         // 失败原因
    ImageUrl        string         // 结果图片URL
    Buttons         string         // 操作按钮（JSON）
    ChannelId       int            // 渠道ID
    Quota           int            // 消耗配额
}
```

### 10. Redemption (兑换码表)

兑换码管理。

```go
type Redemption struct {
    Id          int            // 兑换码ID
    UserId      int            // 创建用户ID
    Key         string         // 兑换码（唯一）
    Status      int            // 状态：1=未使用, 2=已使用, 3=已禁用
    Name        string         // 名称
    Quota       int            // 配额
    CreatedTime int64          // 创建时间
    RedeemedTime int64         // 兑换时间
    RedeemedUserId int         // 兑换用户ID
    Count       int            // 可兑换次数（-1=无限）
    UsedCount   int            // 已兑换次数
}
```

### 11. TopUp (充值记录表)

用户充值记录。

```go
type TopUp struct {
    Id          int            // 充值ID
    UserId      int            // 用户ID
    Amount      int            // 充值金额
    Quota       int            // 获得配额
    Status      int            // 状态：1=待支付, 2=已支付, 3=已取消
    CreatedTime int64          // 创建时间
    PayTime     int64          // 支付时间
}
```

### 12. Option (系统配置表)

系统配置键值对存储。

```go
type Option struct {
    Key   string         // 配置键（唯一）
    Value string         // 配置值（JSON）
}
```

**常用配置项**:
- `SystemName`: 系统名称
- `Logo`: Logo URL
- `HomePageContent`: 首页内容
- `AboutContent`: 关于页面内容
- `FooterHTML`: 页脚HTML
- `RegisterEnabled`: 是否允许注册
- `EmailVerificationEnabled`: 是否启用邮箱验证
- `GitHubOAuthEnabled`: GitHub OAuth
- `DiscordOAuthEnabled`: Discord OAuth
- `OIDCEnabled`: OIDC OAuth
- `SMTPServer`: SMTP服务器配置
- `QuotaPerUnit`: 每单位配额
- `DisplayInCurrencyEnabled`: 是否显示货币
- `BillingEnabled`: 是否启用计费

### 13. Ability (能力表)

系统能力配置（模型、分组映射）。

```go
type Ability struct {
    Group   string         // 分组
    Model   string         // 模型
    Enabled bool           // 是否启用
}
```

### 14. QuotaData (配额数据表)

配额统计数据（用于仪表板）。

```go
type QuotaData struct {
    Time  int64          // 时间（Unix时间戳）
    Quota int64          // 配额
}
```

### 15. 认证相关表

#### PasskeyCredential (Passkey凭证)

```go
type PasskeyCredential struct {
    Id              int            // 凭证ID
    UserId          int            // 用户ID
    CredentialId    string         // 凭证ID（Base64）
    PublicKey       string         // 公钥（Base64）
    AttestationType string         // 认证类型
    AAGUID          string         // AAGUID
    SignCount       uint32         // 签名计数
    CreatedAt       int64          // 创建时间
    LastUsedAt      int64          // 最后使用时间
    Name            string         // 凭证名称
}
```

#### TwoFA (双因素认证)

```go
type TwoFA struct {
    UserId    int            // 用户ID（主键）
    Secret    string         // TOTP密钥
    Enabled   bool           // 是否启用
    CreatedAt int64          // 创建时间
    UpdatedAt int64          // 更新时间
}
```

#### TwoFABackupCode (2FA备份码)

```go
type TwoFABackupCode struct {
    Id        int            // 备份码ID
    UserId    int            // 用户ID
    Code      string         // 备份码（哈希）
    Used      bool           // 是否已使用
    CreatedAt int64          // 创建时间
    UsedAt    int64          // 使用时间
}
```

### 16. OAuth相关表

#### CustomOAuthProvider (自定义OAuth提供商)

```go
type CustomOAuthProvider struct {
    Id           int            // 提供商ID
    Name         string         // 名称（唯一）
    DisplayName  string         // 显示名称
    ClientId     string         // 客户端ID
    ClientSecret string         // 客户端密钥
    AuthURL      string         // 授权URL
    TokenURL     string         // Token URL
    UserInfoURL  string         // 用户信息URL
    Scopes       string         // 权限范围
    Enabled      bool           // 是否启用
    CreatedAt    int64          // 创建时间
    UpdatedAt    int64          // 更新时间
}
```

#### UserOAuthBinding (用户OAuth绑定)

```go
type UserOAuthBinding struct {
    Id           int            // 绑定ID
    UserId       int            // 用户ID
    ProviderId   int            // 提供商ID
    ProviderName string         // 提供商名称
    OpenId       string         // OpenID
    CreatedAt    int64          // 创建时间
}
```

### 17. 其他表

#### Setup (系统设置)

```go
type Setup struct {
    Version       string         // 版本
    InitializedAt int64          // 初始化时间
}
```

#### Checkin (签到记录)

```go
type Checkin struct {
    Id        int            // 签到ID
    UserId    int            // 用户ID
    Date      string         // 日期（YYYY-MM-DD）
    Quota     int            // 获得配额
    CreatedAt int64          // 创建时间
}
```

#### PrefillGroup (预填充组)

```go
type PrefillGroup struct {
    Id          int            // 组ID
    Name        string         // 组名（唯一）
    Description string         // 描述
    Models      string         // 模型列表（JSON）
    CreatedAt   int64          // 创建时间
    UpdatedAt   int64          // 更新时间
}
```

## 数据库关系图

```
User (用户)
  ├─→ Token (令牌) [1:N]
  ├─→ Log (日志) [1:N]
  ├─→ UserSubscription (订阅) [1:N]
  ├─→ SubscriptionOrder (订单) [1:N]
  ├─→ Task (任务) [1:N]
  ├─→ Midjourney (MJ任务) [1:N]
  ├─→ Redemption (兑换码) [1:N]
  ├─→ TopUp (充值) [1:N]
  ├─→ PasskeyCredential (Passkey) [1:N]
  ├─→ TwoFA (2FA) [1:1]
  ├─→ TwoFABackupCode (备份码) [1:N]
  └─→ UserOAuthBinding (OAuth绑定) [1:N]

Channel (渠道)
  └─→ Log (日志) [1:N]

SubscriptionPlan (订阅计划)
  ├─→ UserSubscription (用户订阅) [1:N]
  └─→ SubscriptionOrder (订单) [1:N]

Vendor (供应商)
  └─→ Model (模型) [1:N]

CustomOAuthProvider (OAuth提供商)
  └─→ UserOAuthBinding (OAuth绑定) [1:N]
```

## 数据库迁移

### 自动迁移

系统启动时自动执行数据库迁移（仅主节点）：

```go
func migrateDB() error {
    return DB.AutoMigrate(
        &Channel{},
        &Token{},
        &User{},
        &PasskeyCredential{},
        &Option{},
        &Redemption{},
        &Ability{},
        &Log{},
        &Midjourney{},
        &TopUp{},
        &QuotaData{},
        &Task{},
        &Model{},
        &Vendor{},
        &PrefillGroup{},
        &Setup{},
        &TwoFA{},
        &TwoFABackupCode{},
        &Checkin{},
        &SubscriptionOrder{},
        &UserSubscription{},
        &SubscriptionPreConsumeRecord{},
        &CustomOAuthProvider{},
        &UserOAuthBinding{},
    )
}
```

### 特殊处理

1. **SQLite 的 SubscriptionPlan 表**
   - SQLite 不支持 `ALTER COLUMN`
   - 使用自定义 SQL 创建表
   - 使用 `ADD COLUMN` 添加新列

2. **price_amount 列迁移**
   - 从 float/double 迁移到 decimal(10,6)
   - 确保价格精度

## 查询优化建议

### 1. 使用索引

所有频繁查询的字段都已建立索引：
- 用户名、邮箱、OAuth ID
- 令牌 Key
- 渠道名称、标签
- 日志的用户ID、创建时间、渠道ID

### 2. 分页查询

```go
// 使用 Limit 和 Offset
DB.Limit(pageSize).Offset(startIdx).Find(&results)
```

### 3. 预加载关联

```go
// 预加载用户的令牌
DB.Preload("Tokens").Find(&users)
```

### 4. 选择特定字段

```go
// 只查询需要的字段
DB.Select("id", "username", "email").Find(&users)
```

### 5. 批量操作

```go
// 批量插入
DB.CreateInBatches(records, 100)

// 批量更新
DB.Model(&User{}).Where("status = ?", 1).Update("quota", gorm.Expr("quota + ?", 100))
```

## 数据备份建议

### 1. SQLite

```bash
# 备份
sqlite3 new-api.db ".backup new-api-backup.db"

# 恢复
sqlite3 new-api.db ".restore new-api-backup.db"
```

### 2. MySQL

```bash
# 备份
mysqldump -u user -p database > backup.sql

# 恢复
mysql -u user -p database < backup.sql
```

### 3. PostgreSQL

```bash
# 备份
pg_dump -U user database > backup.sql

# 恢复
psql -U user database < backup.sql
```

## 性能监控

### 1. 慢查询日志

启用 GORM 的日志模式：

```go
if common.DebugEnabled {
    db = db.Debug()
}
```

### 2. 连接池监控

```go
sqlDB, _ := DB.DB()
stats := sqlDB.Stats()
// stats.OpenConnections
// stats.InUse
// stats.Idle
```

### 3. 查询分析

```sql
-- MySQL
EXPLAIN SELECT * FROM users WHERE username = 'test';

-- PostgreSQL
EXPLAIN ANALYZE SELECT * FROM users WHERE username = 'test';
```

## 下一步阅读

- [03-AI中继系统详解.md](./03-AI中继系统详解.md) - AI API 中继核心原理
- [06-计费系统.md](./06-计费系统.md) - 配额和计费详解
