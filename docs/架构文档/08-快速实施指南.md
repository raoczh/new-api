# New API å¿«é€Ÿå®æ–½æŒ‡å—

> åŸºäºåŠŸèƒ½ä¼˜åŒ–è®¡åˆ’çš„å¿«é€Ÿå®æ–½æ‰‹å†Œ
>
> ç”Ÿæˆæ—¶é—´ï¼š2025-02-21

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº† New API é¡¹ç›®ä¼˜åŒ–çš„å¿«é€Ÿå®æ–½æŒ‡å—ï¼ŒåŒ…æ‹¬ï¼š
- 30 ä¸ªä¼˜åŒ–åŠŸèƒ½ç‚¹çš„è¯¦ç»†å®æ–½æ­¥éª¤
- æŒ‰ä¼˜å…ˆçº§å’Œæ—¶é—´çº¿ç»„ç»‡çš„ä»»åŠ¡æ¸…å•
- æ¯ä¸ªåŠŸèƒ½çš„ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µ
- æ€§èƒ½æŒ‡æ ‡å’ŒéªŒæ”¶æ ‡å‡†

---

## ğŸ¯ æ€»ä½“ç›®æ ‡

### åŠŸèƒ½å®Œæ•´åº¦æå‡
- **å½“å‰**: 75%
- **ç¬¬ä¸€é˜¶æ®µå**: 82% (+7%)
- **ç¬¬äºŒé˜¶æ®µå**: 90% (+8%)
- **ç¬¬ä¸‰é˜¶æ®µå**: 95% (+5%)
- **ç¬¬å››é˜¶æ®µå**: 98% (+3%)

### æ€§èƒ½æŒ‡æ ‡æå‡
- **é¦–å±åŠ è½½**: 3s â†’ 1.5s (50% â†‘)
- **Bundle å¤§å°**: 450KB â†’ 350KB (22% â†“)
- **ç”¨æˆ·æ»¡æ„åº¦**: è‰¯å¥½ â†’ ä¼˜ç§€

---

## ğŸš€ ç¬¬ä¸€é˜¶æ®µï¼šP0 é«˜ä¼˜å…ˆçº§åŠŸèƒ½ï¼ˆ2å‘¨ï¼‰

### æ€»å·¥ä½œé‡ï¼š18-26å¤©
### å›¢é˜Ÿé…ç½®ï¼šåç«¯ 2äºº + å‰ç«¯ 2äºº + æµ‹è¯• 1äºº

---

### åŠŸèƒ½ 1ï¼šå®¡è®¡æ—¥å¿—ç³»ç»Ÿ (3-5å¤©)

#### åç«¯å®æ–½æ­¥éª¤

**æ­¥éª¤ 1ï¼šåˆ›å»ºæ•°æ®æ¨¡å‹**
```bash
# åˆ›å»ºæ–‡ä»¶
touch model/audit_log.go
```

```go
// model/audit_log.go
package model

type AuditLog struct {
    Id          int    `json:"id"`
    UserId      int    `json:"user_id" gorm:"index"`
    Username    string `json:"username"`
    Action      string `json:"action" gorm:"index"`      // create_user, delete_channel
    Resource    string `json:"resource" gorm:"index"`    // user, channel, token
    ResourceId  string `json:"resource_id"`
    Details     string `json:"details" gorm:"type:text"` // JSON
    IpAddress   string `json:"ip_address"`
    UserAgent   string `json:"user_agent"`
    Status      string `json:"status"`                   // success, failed
    ErrorMsg    string `json:"error_msg"`
    CreatedAt   int64  `json:"created_at" gorm:"bigint;index"`
}

// è®°å½•å®¡è®¡æ—¥å¿—
func RecordAuditLog(userId int, username, action, resource, resourceId string,
                    details map[string]interface{}, status, errorMsg string) error {
    detailsJson, _ := common.Marshal(details)

    log := &AuditLog{
        UserId:     userId,
        Username:   username,
        Action:     action,
        Resource:   resource,
        ResourceId: resourceId,
        Details:    string(detailsJson),
        Status:     status,
        ErrorMsg:   errorMsg,
        CreatedAt:  time.Now().Unix(),
    }

    return DB.Create(log).Error
}

// æŸ¥è¯¢å®¡è®¡æ—¥å¿—
func GetAuditLogs(page, pageSize int, filters map[string]interface{}) ([]*AuditLog, int64, error) {
    var logs []*AuditLog
    var total int64

    query := DB.Model(&AuditLog{})

    // åº”ç”¨è¿‡æ»¤å™¨
    if userId, ok := filters["user_id"]; ok {
        query = query.Where("user_id = ?", userId)
    }
    if action, ok := filters["action"]; ok {
        query = query.Where("action = ?", action)
    }
    if resource, ok := filters["resource"]; ok {
        query = query.Where("resource = ?", resource)
    }

    // è·å–æ€»æ•°
    query.Count(&total)

    // åˆ†é¡µæŸ¥è¯¢
    err := query.Order("created_at DESC").
        Offset(page * pageSize).
        Limit(pageSize).
        Find(&logs).Error

    return logs, total, err
}
```

**æ­¥éª¤ 2ï¼šæ·»åŠ åˆ°æ•°æ®åº“è¿ç§»**
```go
// model/main.go - migrateDB() å‡½æ•°ä¸­æ·»åŠ 
err := DB.AutoMigrate(
    // ... ç°æœ‰æ¨¡å‹
    &AuditLog{},
)
```

**æ­¥éª¤ 3ï¼šåˆ›å»ºä¸­é—´ä»¶**
```go
// middleware/audit.go
package middleware

func AuditLog() gin.HandlerFunc {
    return func(c *gin.Context) {
        // è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´
        startTime := time.Now()

        // è·å–ç”¨æˆ·ä¿¡æ¯
        userId := c.GetInt("id")
        username := c.GetString("username")

        // å¤„ç†è¯·æ±‚
        c.Next()

        // åªè®°å½•ç®¡ç†æ“ä½œ
        if shouldAudit(c.Request.Method, c.Request.URL.Path) {
            action, resource, resourceId := parseRequest(c)
            status := "success"
            errorMsg := ""

            if len(c.Errors) > 0 {
                status = "failed"
                errorMsg = c.Errors.String()
            }

            details := map[string]interface{}{
                "method":       c.Request.Method,
                "path":         c.Request.URL.Path,
                "duration_ms":  time.Since(startTime).Milliseconds(),
                "status_code":  c.Writer.Status(),
            }

            model.RecordAuditLog(userId, username, action, resource,
                                resourceId, details, status, errorMsg)
        }
    }
}

func shouldAudit(method, path string) bool {
    // åªå®¡è®¡ç®¡ç†æ“ä½œ
    auditPaths := []string{
        "/api/user/",
        "/api/channel/",
        "/api/token/",
        "/api/option/",
    }

    for _, p := range auditPaths {
        if strings.HasPrefix(path, p) &&
           (method == "POST" || method == "PUT" || method == "DELETE") {
            return true
        }
    }
    return false
}
```

**æ­¥éª¤ 4ï¼šåˆ›å»º API æ§åˆ¶å™¨**
```go
// controller/audit_log.go
package controller

func GetAuditLogs(c *gin.Context) {
    page, _ := strconv.Atoi(c.Query("page"))
    pageSize, _ := strconv.Atoi(c.Query("size"))

    filters := make(map[string]interface{})
    if userId := c.Query("user_id"); userId != "" {
        filters["user_id"], _ = strconv.Atoi(userId)
    }
    if action := c.Query("action"); action != "" {
        filters["action"] = action
    }
    if resource := c.Query("resource"); resource != "" {
        filters["resource"] = resource
    }

    logs, total, err := model.GetAuditLogs(page, pageSize, filters)
    if err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{
            "success": false,
            "message": "æŸ¥è¯¢å¤±è´¥",
        })
        return
    }

    c.JSON(http.StatusOK, gin.H{
        "success": true,
        "data":    logs,
        "total":   total,
    })
}
```

**æ­¥éª¤ 5ï¼šæ·»åŠ è·¯ç”±**
```go
// router/api-router.go
apiRouter.GET("/audit-logs", middleware.AdminAuth(), controller.GetAuditLogs)
```

#### å‰ç«¯å®æ–½æ­¥éª¤

**æ­¥éª¤ 1ï¼šåˆ›å»ºå®¡è®¡æ—¥å¿—é¡µé¢**
```bash
# åˆ›å»ºæ–‡ä»¶
mkdir -p web/src/pages
touch web/src/pages/AuditLog.jsx
```

```jsx
// web/src/pages/AuditLog.jsx
import React, { useState, useEffect } from 'react';
import { Table, Card, Select, Input, DatePicker, Button, Tag } from '@douyinfe/semi-ui';
import { useTranslation } from 'react-i18next';
import API from '../service/api';

function AuditLog() {
  const { t } = useTranslation();
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(true);
  const [pagination, setPagination] = useState({
    currentPage: 1,
    pageSize: 20,
    total: 0,
  });
  const [filters, setFilters] = useState({
    action: '',
    resource: '',
    user_id: '',
  });

  useEffect(() => {
    loadLogs();
  }, [pagination.currentPage, filters]);

  const loadLogs = async () => {
    setLoading(true);
    try {
      const res = await API.get('/api/audit-logs', {
        params: {
          page: pagination.currentPage - 1,
          size: pagination.pageSize,
          ...filters,
        },
      });
      setLogs(res.data.data);
      setPagination({ ...pagination, total: res.data.total });
    } catch (error) {
      console.error('åŠ è½½å®¡è®¡æ—¥å¿—å¤±è´¥', error);
    } finally {
      setLoading(false);
    }
  };

  const columns = [
    {
      title: t('æ—¶é—´'),
      dataIndex: 'created_at',
      render: (time) => new Date(time * 1000).toLocaleString(),
    },
    {
      title: t('ç”¨æˆ·'),
      dataIndex: 'username',
    },
    {
      title: t('æ“ä½œ'),
      dataIndex: 'action',
      render: (action) => <Tag>{action}</Tag>,
    },
    {
      title: t('èµ„æº'),
      dataIndex: 'resource',
    },
    {
      title: t('èµ„æºID'),
      dataIndex: 'resource_id',
    },
    {
      title: t('çŠ¶æ€'),
      dataIndex: 'status',
      render: (status) => (
        <Tag color={status === 'success' ? 'green' : 'red'}>
          {status}
        </Tag>
      ),
    },
    {
      title: t('è¯¦æƒ…'),
      dataIndex: 'details',
      render: (details) => (
        <Button size="small" onClick={() => showDetails(details)}>
          {t('æŸ¥çœ‹')}
        </Button>
      ),
    },
  ];

  return (
    <Card title={t('å®¡è®¡æ—¥å¿—')}>
      <div style={{ marginBottom: 16, display: 'flex', gap: 8 }}>
        <Select
          placeholder={t('æ“ä½œç±»å‹')}
          style={{ width: 200 }}
          onChange={(value) => setFilters({ ...filters, action: value })}
        >
          <Select.Option value="">å…¨éƒ¨</Select.Option>
          <Select.Option value="create_user">åˆ›å»ºç”¨æˆ·</Select.Option>
          <Select.Option value="delete_user">åˆ é™¤ç”¨æˆ·</Select.Option>
          <Select.Option value="create_channel">åˆ›å»ºæ¸ é“</Select.Option>
          <Select.Option value="delete_channel">åˆ é™¤æ¸ é“</Select.Option>
        </Select>

        <Select
          placeholder={t('èµ„æºç±»å‹')}
          style={{ width: 200 }}
          onChange={(value) => setFilters({ ...filters, resource: value })}
        >
          <Select.Option value="">å…¨éƒ¨</Select.Option>
          <Select.Option value="user">ç”¨æˆ·</Select.Option>
          <Select.Option value="channel">æ¸ é“</Select.Option>
          <Select.Option value="token">ä»¤ç‰Œ</Select.Option>
          <Select.Option value="option">é…ç½®</Select.Option>
        </Select>

        <Button onClick={loadLogs}>{t('åˆ·æ–°')}</Button>
      </div>

      <Table
        columns={columns}
        dataSource={logs}
        loading={loading}
        pagination={{
          currentPage: pagination.currentPage,
          pageSize: pagination.pageSize,
          total: pagination.total,
          onPageChange: (page) =>
            setPagination({ ...pagination, currentPage: page }),
        }}
      />
    </Card>
  );
}

export default AuditLog;
```

**æ­¥éª¤ 2ï¼šæ·»åŠ è·¯ç”±**
```jsx
// web/src/App.jsx
import AuditLog from './pages/AuditLog';

<Route
  path="/console/audit-logs"
  element={
    <AdminRoute>
      <AuditLog />
    </AdminRoute>
  }
/>
```

**æ­¥éª¤ 3ï¼šæ·»åŠ ä¾§è¾¹æ èœå•**
```jsx
// web/src/components/layout/SiderBar.jsx
{
  itemKey: 'audit-logs',
  text: t('å®¡è®¡æ—¥å¿—'),
  icon: <IconHistogram />,
  path: '/console/audit-logs',
}
```

#### éªŒæ”¶æ ‡å‡†
- [ ] æ‰€æœ‰ç®¡ç†æ“ä½œéƒ½è¢«è®°å½•
- [ ] å¯ä»¥æŒ‰ç”¨æˆ·ã€æ“ä½œç±»å‹ã€èµ„æºç±»å‹ç­›é€‰
- [ ] å¯ä»¥æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼ˆJSON æ ¼å¼ï¼‰
- [ ] æ”¯æŒåˆ†é¡µæŸ¥è¯¢
- [ ] æ”¯æŒå¯¼å‡ºå®¡è®¡æŠ¥å‘Š

---

### åŠŸèƒ½ 25ï¼šé¦–å±åŠ è½½æ€§èƒ½ä¼˜åŒ– (3-4å¤©)

#### å®æ–½æ­¥éª¤

**æ­¥éª¤ 1ï¼šä¼˜åŒ– Vite é…ç½®**
```javascript
// web/vite.config.js
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import { visualizer } from 'rollup-plugin-visualizer';
import viteCompression from 'vite-plugin-compression';

export default defineConfig({
  plugins: [
    react(),
    // Gzip å‹ç¼©
    viteCompression({
      algorithm: 'gzip',
      ext: '.gz',
    }),
    // Brotli å‹ç¼©
    viteCompression({
      algorithm: 'brotliCompress',
      ext: '.br',
    }),
    // Bundle åˆ†æ
    visualizer({
      open: true,
      gzipSize: true,
      brotliSize: true,
    }),
  ],
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          // React æ ¸å¿ƒ
          'react-core': ['react', 'react-dom', 'react-router-dom'],

          // Semi UI
          'semi-ui': ['@douyinfe/semi-ui', '@douyinfe/semi-icons'],

          // å›¾è¡¨åº“ï¼ˆå•ç‹¬åˆ†å‰²ï¼‰
          'charts': ['@visactor/vchart', '@visactor/react-vchart'],

          // Markdown ç›¸å…³
          'markdown': ['react-markdown', 'remark-gfm', 'rehype-katex'],

          // Mermaidï¼ˆå»¶è¿ŸåŠ è½½ï¼‰
          'mermaid': ['mermaid'],

          // å›½é™…åŒ–
          'i18n': ['i18next', 'react-i18next', 'i18next-browser-languagedetector'],

          // å·¥å…·åº“
          'tools': ['axios', 'copy-to-clipboard', 'dayjs', 'lodash'],
        },
      },
    },
    // ä»£ç åˆ†å‰²é˜ˆå€¼
    chunkSizeWarningLimit: 500,
  },
});
```

**æ­¥éª¤ 2ï¼šå»¶è¿ŸåŠ è½½é‡å‹åº“**
```jsx
// web/src/components/common/markdown/MarkdownRenderer.jsx
import React, { lazy, Suspense } from 'react';

// å»¶è¿ŸåŠ è½½ Mermaid
const Mermaid = lazy(() => import('./MermaidComponent'));

function MarkdownRenderer({ content }) {
  const hasMermaid = content.includes('```mermaid');

  return (
    <div>
      <ReactMarkdown>{content}</ReactMarkdown>

      {hasMermaid && (
        <Suspense fallback={<div>åŠ è½½å›¾è¡¨...</div>}>
          <Mermaid content={content} />
        </Suspense>
      )}
    </div>
  );
}
```

**æ­¥éª¤ 3ï¼šæ·»åŠ èµ„æºé¢„åŠ è½½**
```html
<!-- web/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- DNS é¢„è§£æ -->
  <link rel="dns-prefetch" href="https://api.example.com">

  <!-- é¢„è¿æ¥ -->
  <link rel="preconnect" href="https://api.example.com">

  <!-- é¢„åŠ è½½å…³é”®èµ„æº -->
  <link rel="preload" href="/assets/main.js" as="script">
  <link rel="preload" href="/assets/main.css" as="style">

  <!-- é¢„åŠ è½½å­—ä½“ -->
  <link rel="preload" href="/fonts/lato.woff2" as="font" type="font/woff2" crossorigin>

  <!-- é¢„åŠ è½½å¸¸ç”¨é¡µé¢ -->
  <link rel="prefetch" href="/dashboard">
  <link rel="prefetch" href="/playground">

  <title>New API</title>
</head>
<body>
  <div id="root"></div>
  <script type="module" src="/src/index.jsx"></script>
</body>
</html>
```

**æ­¥éª¤ 4ï¼šä¼˜åŒ–å›¾ç‰‡åŠ è½½**
```jsx
// web/src/components/common/ui/OptimizedImage.jsx
import React from 'react';

function OptimizedImage({ src, alt, ...props }) {
  return (
    <picture>
      {/* WebP æ ¼å¼ */}
      <source srcSet={src.replace(/\.(jpg|png)$/, '.webp')} type="image/webp" />

      {/* åŸå§‹æ ¼å¼ */}
      <img
        src={src}
        alt={alt}
        loading="lazy"
        decoding="async"
        {...props}
      />
    </picture>
  );
}

export default OptimizedImage;
```

**æ­¥éª¤ 5ï¼šæ·»åŠ åŠ è½½è¿›åº¦æ¡**
```bash
# å®‰è£…ä¾èµ–
cd web
bun add nprogress
```

```jsx
// web/src/App.jsx
import NProgress from 'nprogress';
import 'nprogress/nprogress.css';

// é…ç½® NProgress
NProgress.configure({ showSpinner: false });

function App() {
  const location = useLocation();

  useEffect(() => {
    NProgress.start();
    const timer = setTimeout(() => NProgress.done(), 500);
    return () => {
      clearTimeout(timer);
      NProgress.done();
    };
  }, [location.pathname]);

  return (
    // ...
  );
}
```

#### éªŒæ”¶æ ‡å‡†
- [ ] FCP < 1s
- [ ] LCP < 1.5s
- [ ] Bundle Size < 350KB
- [ ] Lighthouse åˆ†æ•° > 90
- [ ] é¦–å±åŠ è½½æ—¶é—´ < 2s

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•æ¸…å•

### ä½¿ç”¨ Lighthouse æµ‹è¯•
```bash
# å®‰è£… Lighthouse
npm install -g lighthouse

# è¿è¡Œæµ‹è¯•
lighthouse http://localhost:3000 --view
```

### ä½¿ç”¨ WebPageTest
è®¿é—® https://www.webpagetest.org/
è¾“å…¥ä½ çš„ç½‘ç«™ URL è¿›è¡Œæµ‹è¯•

### ä½¿ç”¨ Chrome DevTools
1. æ‰“å¼€ Chrome DevTools (F12)
2. åˆ‡æ¢åˆ° Performance æ ‡ç­¾
3. ç‚¹å‡»å½•åˆ¶æŒ‰é’®
4. åˆ·æ–°é¡µé¢
5. åœæ­¢å½•åˆ¶å¹¶åˆ†æç»“æœ

---

## ğŸ¯ å¿«é€Ÿæ£€æŸ¥æ¸…å•

### æ¯æ—¥æ£€æŸ¥
- [ ] ä»£ç å·²æäº¤åˆ° Git
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥å®Œæˆ
- [ ] æ–‡æ¡£å·²æ›´æ–°

### æ¯å‘¨æ£€æŸ¥
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] å®‰å…¨æ‰«æé€šè¿‡
- [ ] ç”¨æˆ·åé¦ˆæ”¶é›†
- [ ] Bug ä¿®å¤å®Œæˆ

### å‘å¸ƒå‰æ£€æŸ¥
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡
- [ ] æ–‡æ¡£å®Œæ•´
- [ ] å¤‡ä»½å·²åˆ›å»º
- [ ] å›æ»šæ–¹æ¡ˆå‡†å¤‡

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- [å®Œæ•´åŠŸèƒ½ä¼˜åŒ–è®¡åˆ’](./07-åŠŸèƒ½ä¼˜åŒ–å’Œæ–°å¢è®¡åˆ’.md)
- [åç«¯æ¶æ„æ€»è§ˆ](./01-åç«¯æ¶æ„æ€»è§ˆ.md)
- [å‰ç«¯æ¶æ„æ€»è§ˆ](./04-å‰ç«¯æ¶æ„æ€»è§ˆ.md)
- [GitHub Issues](https://github.com/Calcium-Ion/new-api/issues)

---

**æœ€åæ›´æ–°**: 2025-02-21
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
