# New API 架构文档索引

## 文档概述

本文档集提供了 New API 项目的完整架构说明和开发指南，帮助开发者快速理解项目结构、工作原理，并能够直接进入开发。

## 项目简介

**New API** 是一个基于 Go + React 构建的 AI API 网关系统，聚合了 40+ 个上游 AI 提供商（OpenAI、Claude、Gemini、Azure、AWS Bedrock 等），提供统一的 OpenAI 兼容 API 接口，并具备完整的用户管理、计费、速率限制、监控等功能。

### 核心特性

- ✅ **统一接口**: 提供 OpenAI 兼容的统一 API
- ✅ **多提供商支持**: 支持 40+ AI 提供商
- ✅ **智能分发**: 基于权重、优先级、亲和性的渠道选择
- ✅ **格式转换**: 自动转换不同提供商的 API 格式
- ✅ **用户管理**: 完整的用户、令牌、权限管理
- ✅ **计费系统**: 精确的 Token 计数和配额管理
- ✅ **订阅系统**: 支持订阅计划和配额重置
- ✅ **监控日志**: 完整的请求日志和统计分析
- ✅ **多数据库**: 支持 SQLite、MySQL、PostgreSQL
- ✅ **国际化**: 支持中文、英文、法语、俄语、日语、越南语

### 技术栈

**后端**:
- Go 1.22+
- Gin Web Framework
- GORM v2 ORM
- Redis (可选)

**前端**:
- React 18
- Vite
- Semi Design UI
- React Router v6
- i18next

## 文档结构

### 📚 核心架构文档

#### [01-后端架构总览.md](./01-后端架构总览.md)
**适合**: 后端开发者、架构师

**内容**:
- 后端分层架构设计
- 目录结构详解（490+ Go 文件）
- 启动流程和初始化
- 核心功能模块（用户、令牌、渠道、计费等）
- 数据库设计原则
- 关键设计模式
- 性能优化策略
- 安全机制

**关键知识点**:
- Router → Middleware → Controller → Service → Model 分层架构
- 39+ AI 提供商支持
- 多数据库兼容性设计
- JSON 处理规范（必须使用 `common/json.go`）

---

#### [02-数据库模型设计.md](./02-数据库模型设计.md)
**适合**: 后端开发者、数据库管理员

**内容**:
- 完整的数据库表结构（25+ 表）
- 核心模型详解（User、Token、Channel、Log 等）
- 数据库关系图
- 索引设计
- 数据库迁移
- 查询优化建议
- 备份策略

**关键知识点**:
- 用户、令牌、渠道、日志等核心表结构
- 订阅系统表设计
- 多 Key 管理机制
- 认证相关表（Passkey、2FA、OAuth）
- 跨数据库兼容性处理

---

#### [03-AI中继系统详解.md](./03-AI中继系统详解.md)
**适合**: 后端开发者、想要添加新 AI 提供商的开发者

**内容**:
- AI 中继系统架构
- 39+ AI 提供商列表
- 中继模式（Relay Mode）
- 渠道分发流程
- 渠道适配器（Adaptor）设计
- 流式响应处理（SSE）
- 请求重试机制
- Token 计数
- 计费流程
- 错误处理

**关键知识点**:
- Distributor Middleware 渠道分发核心
- 渠道亲和性（Channel Affinity）
- 适配器接口实现
- OpenAI、Claude、Gemini 格式转换
- 流式响应 SSE 处理

---

#### [04-前端架构总览.md](./04-前端架构总览.md)
**适合**: 前端开发者

**内容**:
- React 18 + Vite 项目结构
- 组件库架构（232+ 组件）
- 路由配置和权限控制
- 状态管理（Context API）
- 表格组件设计模式
- API 服务封装
- 国际化系统（i18next）
- 主题系统
- 性能优化
- 构建和部署

**关键知识点**:
- 模块化表格组件设计
- PrivateRoute、AdminRoute 权限控制
- Context 状态管理
- Semi Design UI 使用
- 代码分割和懒加载

---

#### [05-完整工作原理.md](./05-完整工作原理.md)
**适合**: 所有开发者、想要深入理解系统的人

**内容**:
- 完整的请求处理流程（15 个步骤）
- 从客户端请求到响应的完整链路
- 错误处理和重试机制
- 缓存系统（渠道缓存、配置缓存、Redis）
- 监控和统计
- 订阅系统工作流程
- 多 Key 管理
- 安全机制（认证、速率限制、IP 白名单）
- 性能优化策略

**关键知识点**:
- 请求流程图（从接收到返回）
- 渠道选择策略
- Token 计数和计费
- 渠道亲和性记录
- 自动禁用机制

---

#### [06-快速开发指南.md](./06-快速开发指南.md)
**适合**: 新手开发者、想要快速上手的人

**内容**:
- 环境搭建（Go、Node.js、数据库）
- 后端开发指南
  - 添加新的 API 端点
  - 添加新的 AI 提供商适配器
  - 添加中间件
- 前端开发指南
  - 创建新页面
  - 创建表格组件
  - 添加 API 服务
- 常见开发任务
  - 添加系统配置项
  - 添加用户角色
  - 添加模型定价
- 调试技巧
- 部署指南（Docker、Docker Compose、Nginx、Systemd）

**关键知识点**:
- 完整的开发环境配置
- 代码示例和最佳实践
- 生产环境部署方案

---

## 快速导航

### 🎯 我想了解...

#### 后端架构
- **整体架构** → [01-后端架构总览.md](./01-后端架构总览.md)
- **数据库设计** → [02-数据库模型设计.md](./02-数据库模型设计.md)
- **AI 中继系统** → [03-AI中继系统详解.md](./03-AI中继系统详解.md)

#### 前端架构
- **前端整体架构** → [04-前端架构总览.md](./04-前端架构总览.md)

#### 系统原理
- **完整工作流程** → [05-完整工作原理.md](./05-完整工作原理.md)

#### 开发实践
- **快速开发** → [06-快速开发指南.md](./06-快速开发指南.md)

---

### 🔧 我想做...

#### 添加新功能
1. 阅读 [01-后端架构总览.md](./01-后端架构总览.md) 了解分层架构
2. 阅读 [06-快速开发指南.md](./06-快速开发指南.md) 的"添加新的 API 端点"部分
3. 参考现有代码实现

#### 添加新的 AI 提供商
1. 阅读 [03-AI中继系统详解.md](./03-AI中继系统详解.md) 了解适配器设计
2. 阅读 [06-快速开发指南.md](./06-快速开发指南.md) 的"添加新的 AI 提供商适配器"部分
3. 参考 `relay/channel/openai/` 或 `relay/channel/claude/` 实现

#### 修改数据库结构
1. 阅读 [02-数据库模型设计.md](./02-数据库模型设计.md) 了解现有结构
2. 阅读 [01-后端架构总览.md](./01-后端架构总览.md) 的"数据库设计原则"
3. 确保兼容 SQLite、MySQL、PostgreSQL

#### 开发前端页面
1. 阅读 [04-前端架构总览.md](./04-前端架构总览.md) 了解组件架构
2. 阅读 [06-快速开发指南.md](./06-快速开发指南.md) 的"创建新页面"部分
3. 参考 `web/src/pages/` 和 `web/src/components/table/` 现有实现

#### 调试问题
1. 阅读 [06-快速开发指南.md](./06-快速开发指南.md) 的"调试技巧"部分
2. 阅读 [05-完整工作原理.md](./05-完整工作原理.md) 了解请求流程
3. 启用 DEBUG 模式查看详细日志

#### 部署到生产环境
1. 阅读 [06-快速开发指南.md](./06-快速开发指南.md) 的"部署指南"部分
2. 选择部署方式（Docker / Docker Compose / 直接部署）
3. 配置 Nginx 反向代理和 SSL

---

## 学习路径

### 🌟 新手路径（0-1周）

1. **第1天**: 阅读 [README.md](../../README.md) 和本文档，了解项目概况
2. **第2天**: 阅读 [06-快速开发指南.md](./06-快速开发指南.md)，搭建开发环境
3. **第3天**: 阅读 [01-后端架构总览.md](./01-后端架构总览.md)，理解后端架构
4. **第4天**: 阅读 [04-前端架构总览.md](./04-前端架构总览.md)，理解前端架构
5. **第5天**: 阅读 [05-完整工作原理.md](./05-完整工作原理.md)，理解系统流程
6. **第6-7天**: 尝试添加简单功能，熟悉代码

### 🚀 进阶路径（1-2周）

1. **深入后端**: 阅读 [02-数据库模型设计.md](./02-数据库模型设计.md) 和 [03-AI中继系统详解.md](./03-AI中继系统详解.md)
2. **实践开发**: 尝试添加新的 API 端点、新的 AI 提供商
3. **代码阅读**: 深入阅读核心模块代码（middleware、service、relay）
4. **性能优化**: 学习缓存、连接池、批量更新等优化技巧

### 💎 专家路径（2周+）

1. **架构优化**: 理解分层架构，提出改进方案
2. **新功能开发**: 独立开发复杂功能模块
3. **性能调优**: 使用 pprof 进行性能分析和优化
4. **贡献代码**: 向项目提交 Pull Request

---

## 核心概念速查

### 后端核心概念

| 概念 | 说明 | 文档位置 |
|------|------|---------|
| **分层架构** | Router → Middleware → Controller → Service → Model | [01-后端架构总览.md](./01-后端架构总览.md) |
| **渠道分发** | 根据权重、优先级、亲和性选择 AI 提供商 | [03-AI中继系统详解.md](./03-AI中继系统详解.md) |
| **渠道适配器** | 转换不同 AI 提供商的 API 格式 | [03-AI中继系统详解.md](./03-AI中继系统详解.md) |
| **渠道亲和性** | 优先使用最近成功的渠道 | [05-完整工作原理.md](./05-完整工作原理.md) |
| **多 Key 管理** | 一个渠道支持多个 API Key | [02-数据库模型设计.md](./02-数据库模型设计.md) |
| **Token 计数** | 使用 tiktoken 计算 Token 数量 | [03-AI中继系统详解.md](./03-AI中继系统详解.md) |
| **配额管理** | 用户、令牌、渠道的配额扣除 | [05-完整工作原理.md](./05-完整工作原理.md) |
| **流式响应** | SSE (Server-Sent Events) 处理 | [03-AI中继系统详解.md](./03-AI中继系统详解.md) |
| **请求重试** | 失败时自动重试其他渠道 | [05-完整工作原理.md](./05-完整工作原理.md) |
| **自动禁用** | 渠道连续失败时自动禁用 | [05-完整工作原理.md](./05-完整工作原理.md) |

### 前端核心概念

| 概念 | 说明 | 文档位置 |
|------|------|---------|
| **模块化表格** | 表格组件拆分为多个子组件 | [04-前端架构总览.md](./04-前端架构总览.md) |
| **权限路由** | PrivateRoute、AdminRoute | [04-前端架构总览.md](./04-前端架构总览.md) |
| **Context 状态** | 用户、系统状态、主题管理 | [04-前端架构总览.md](./04-前端架构总览.md) |
| **国际化** | i18next 多语言支持 | [04-前端架构总览.md](./04-前端架构总览.md) |
| **API 封装** | Axios 请求拦截器 | [04-前端架构总览.md](./04-前端架构总览.md) |

---

## 代码规范

### 后端规范

1. **JSON 处理**: 必须使用 `common/json.go` 中的函数
2. **数据库兼容**: 确保代码兼容 SQLite、MySQL、PostgreSQL
3. **错误处理**: 使用 `types.NewAPIError` 返回错误
4. **日志记录**: 使用 `common.SysLog`、`common.SysError`
5. **命名规范**: 驼峰命名，导出函数首字母大写

### 前端规范

1. **组件命名**: 大驼峰命名（PascalCase）
2. **文件命名**: 与组件名一致
3. **国际化**: 使用 `t()` 函数翻译所有文本
4. **API 调用**: 统一使用 `API` 对象
5. **错误处理**: 使用 `Toast` 显示错误信息

---

## 常见问题

### Q: 如何添加新的 AI 提供商？
**A**: 阅读 [03-AI中继系统详解.md](./03-AI中继系统详解.md) 和 [06-快速开发指南.md](./06-快速开发指南.md) 的相关章节。

### Q: 如何修改数据库结构？
**A**: 阅读 [02-数据库模型设计.md](./02-数据库模型设计.md)，注意多数据库兼容性。

### Q: 如何调试请求流程？
**A**: 启用 DEBUG 模式，阅读 [05-完整工作原理.md](./05-完整工作原理.md) 了解完整流程。

### Q: 如何部署到生产环境？
**A**: 阅读 [06-快速开发指南.md](./06-快速开发指南.md) 的"部署指南"部分。

### Q: 前端如何添加新页面？
**A**: 阅读 [04-前端架构总览.md](./04-前端架构总览.md) 和 [06-快速开发指南.md](./06-快速开发指南.md)。

---

## 贡献指南

欢迎贡献代码！在提交 Pull Request 之前，请：

1. 阅读相关架构文档
2. 确保代码符合规范
3. 添加必要的测试
4. 更新相关文档
5. 提交清晰的 commit 信息

---

## 联系方式

- **GitHub**: https://github.com/Calcium-Ion/new-api
- **Issues**: https://github.com/Calcium-Ion/new-api/issues
- **Discussions**: https://github.com/Calcium-Ion/new-api/discussions

---

## 更新日志

- **2025-02-20**: 创建完整架构文档集
  - 01-后端架构总览
  - 02-数据库模型设计
  - 03-AI中继系统详解
  - 04-前端架构总览
  - 05-完整工作原理
  - 06-快速开发指南
  - README (本文档)

---

## 许可证

本项目采用 AGPL-3.0 许可证。详见 [LICENSE](../../LICENSE) 文件。

---

**祝你开发愉快！** 🚀
