# New API 前端架构总览

## 项目简介

New API 前端是一个基于 React 18 + Vite 构建的现代化单页应用（SPA），提供完整的 AI API 网关管理界面，包括用户管理、渠道配置、令牌管理、日志查询、订阅管理等功能。

## 技术栈

- **框架**: React 18
- **构建工具**: Vite
- **UI 库**: Semi Design (@douyinfe/semi-ui)
- **路由**: React Router v6
- **状态管理**: React Context API
- **HTTP 客户端**: Axios
- **国际化**: i18next + react-i18next
- **包管理器**: Bun (推荐) / npm / yarn / pnpm

## 项目结构

```
web/
├── public/                    # 静态资源
│   ├── favicon.ico
│   └── logo.png
│
├── src/
│   ├── index.jsx             # 应用入口
│   ├── App.jsx               # 根组件（路由配置）
│   ├── index.css             # 全局样式
│   │
│   ├── components/           # 组件库 (232个文件)
│   │   ├── auth/            # 认证组件 (6个)
│   │   │   ├── LoginForm.jsx
│   │   │   ├── RegisterForm.jsx
│   │   │   ├── PasswordResetForm.jsx
│   │   │   ├── PasswordResetConfirm.jsx
│   │   │   ├── TwoFAVerification.jsx
│   │   │   └── OAuth2Callback.jsx
│   │   │
│   │   ├── common/          # 通用组件
│   │   │   ├── ui/          # UI组件 (9个)
│   │   │   │   ├── Loading.jsx
│   │   │   │   ├── CardPro.jsx
│   │   │   │   ├── CardTable.jsx
│   │   │   │   ├── JSONEditor.jsx
│   │   │   │   └── ...
│   │   │   ├── modals/      # 模态框
│   │   │   ├── markdown/    # Markdown渲染
│   │   │   └── logo/        # OAuth图标
│   │   │
│   │   ├── dashboard/       # 仪表板组件 (9个)
│   │   │   ├── index.jsx
│   │   │   ├── DashboardHeader.jsx
│   │   │   ├── StatsCards.jsx
│   │   │   ├── ChartsPanel.jsx
│   │   │   └── ...
│   │   │
│   │   ├── layout/          # 布局组件
│   │   │   ├── PageLayout.jsx
│   │   │   ├── SiderBar.jsx
│   │   │   ├── Footer.jsx
│   │   │   ├── NoticeModal.jsx
│   │   │   ├── SetupCheck.js
│   │   │   └── headerbar/   # 顶部导航栏 (10个)
│   │   │
│   │   ├── table/           # 数据表格 (131个文件)
│   │   │   ├── channels/    # 频道表格 (18个)
│   │   │   ├── users/       # 用户表格 (12个)
│   │   │   ├── tokens/      # 令牌表格 (8个)
│   │   │   ├── models/      # 模型表格 (13个)
│   │   │   ├── model-pricing/ # 模型定价 (复杂结构)
│   │   │   ├── model-deployments/ # 模型部署 (13个)
│   │   │   ├── usage-logs/  # 使用日志 (8个)
│   │   │   ├── task-logs/   # 任务日志
│   │   │   ├── mj-logs/     # Midjourney日志
│   │   │   ├── redemptions/ # 兑换码
│   │   │   └── subscriptions/ # 订阅
│   │   │
│   │   └── settings/        # 设置组件 (15个)
│   │       ├── PersonalSetting.jsx
│   │       ├── SystemSetting.jsx
│   │       ├── ModelSetting.jsx
│   │       ├── OperationSetting.jsx
│   │       └── ...
│   │
│   ├── pages/               # 页面组件 (20个)
│   │   ├── Home.jsx         # 首页
│   │   ├── Dashboard.jsx    # 仪表板
│   │   ├── Channel.jsx      # 频道管理
│   │   ├── Token.jsx        # 令牌管理
│   │   ├── User.jsx         # 用户管理
│   │   ├── Log.jsx          # 日志查询
│   │   ├── Model.jsx        # 模型管理
│   │   ├── Pricing.jsx      # 模型广场
│   │   ├── Subscription.jsx # 订阅管理
│   │   ├── Setting.jsx      # 系统设置
│   │   ├── Chat.jsx         # 聊天界面
│   │   ├── Playground.jsx   # API测试
│   │   └── ...
│   │
│   ├── context/             # Context状态管理
│   │   ├── Status/          # 系统状态
│   │   ├── User/            # 用户状态
│   │   └── Theme/           # 主题状态
│   │
│   ├── helpers/             # 工具函数
│   │   ├── index.js         # 通用工具
│   │   ├── render.js        # 渲染工具
│   │   ├── utils.js         # 实用函数
│   │   └── ...
│   │
│   ├── constants/           # 常量定义
│   │   ├── index.js         # 通用常量
│   │   ├── channel.js       # 渠道常量
│   │   └── ...
│   │
│   ├── i18n/                # 国际化
│   │   ├── index.js         # i18n配置
│   │   └── locales/         # 翻译文件
│   │       ├── zh.json      # 中文（默认）
│   │       ├── en.json      # 英文
│   │       ├── fr.json      # 法语
│   │       ├── ru.json      # 俄语
│   │       ├── ja.json      # 日语
│   │       └── vi.json      # 越南语
│   │
│   └── service/             # API服务
│       ├── api.js           # API封装
│       └── request.js       # HTTP请求封装
│
├── package.json             # 项目配置
├── vite.config.js           # Vite配置
├── bun.lockb                # Bun锁文件
└── README.md                # 项目说明
```

## 核心架构设计

### 1. 应用入口流程

```
index.jsx (入口)
    ↓
App.jsx (路由配置)
    ↓
PageLayout (布局)
    ├── HeaderBar (顶部导航)
    ├── SiderBar (侧边栏)
    ├── Content (主内容区)
    └── Footer (页脚)
    ↓
Page Components (页面组件)
    ↓
Table/Form Components (表格/表单组件)
```

### 2. 路由配置

```jsx
// App.jsx
function App() {
  return (
    <SetupCheck>
      <Routes>
        {/* 公开路由 */}
        <Route path="/" element={<Home />} />
        <Route path="/login" element={<LoginForm />} />
        <Route path="/register" element={<RegisterForm />} />
        <Route path="/pricing" element={<Pricing />} />

        {/* 需要登录的路由 */}
        <Route path="/console" element={
          <PrivateRoute>
            <Dashboard />
          </PrivateRoute>
        } />
        <Route path="/console/token" element={
          <PrivateRoute>
            <Token />
          </PrivateRoute>
        } />

        {/* 需要管理员权限的路由 */}
        <Route path="/console/channel" element={
          <AdminRoute>
            <Channel />
          </AdminRoute>
        } />
        <Route path="/console/user" element={
          <AdminRoute>
            <User />
          </AdminRoute>
        } />

        {/* 404 */}
        <Route path="*" element={<NotFound />} />
      </Routes>
    </SetupCheck>
  );
}
```

### 3. 权限控制

```jsx
// helpers/index.js

// 私有路由（需要登录）
export const PrivateRoute = ({ children }) => {
  const [userState] = useContext(UserContext);

  if (!userState.user) {
    return <Navigate to="/login" replace />;
  }

  return children;
};

// 管理员路由（需要管理员权限）
export const AdminRoute = ({ children }) => {
  const [userState] = useContext(UserContext);

  if (!userState.user) {
    return <Navigate to="/login" replace />;
  }

  if (userState.user.role < 10) {
    return <Navigate to="/forbidden" replace />;
  }

  return children;
};

// 认证重定向（已登录用户访问登录页时重定向）
export const AuthRedirect = ({ children }) => {
  const [userState] = useContext(UserContext);

  if (userState.user) {
    return <Navigate to="/console" replace />;
  }

  return children;
};
```

## 状态管理

### 1. Context 架构

```jsx
// context/Status/index.js
export const StatusContext = createContext();

export const StatusProvider = ({ children }) => {
  const [statusState, setStatusState] = useState({
    status: null,
    loading: true,
  });

  // 加载系统状态
  useEffect(() => {
    loadStatus();
  }, []);

  const loadStatus = async () => {
    try {
      const res = await API.get('/api/status');
      setStatusState({
        status: res.data,
        loading: false,
      });
    } catch (error) {
      console.error('Failed to load status:', error);
    }
  };

  return (
    <StatusContext.Provider value={[statusState, setStatusState]}>
      {children}
    </StatusContext.Provider>
  );
};
```

### 2. 用户状态管理

```jsx
// context/User/index.js
export const UserContext = createContext();

export const UserProvider = ({ children }) => {
  const [userState, setUserState] = useState({
    user: null,
    loading: true,
  });

  // 加载用户信息
  useEffect(() => {
    loadUser();
  }, []);

  const loadUser = async () => {
    try {
      const user = localStorage.getItem('user');
      if (user) {
        setUserState({
          user: JSON.parse(user),
          loading: false,
        });
      } else {
        setUserState({
          user: null,
          loading: false,
        });
      }
    } catch (error) {
      console.error('Failed to load user:', error);
    }
  };

  const login = (user) => {
    localStorage.setItem('user', JSON.stringify(user));
    setUserState({ user, loading: false });
  };

  const logout = () => {
    localStorage.removeItem('user');
    setUserState({ user: null, loading: false });
  };

  return (
    <UserContext.Provider value={[userState, { login, logout }]}>
      {children}
    </UserContext.Provider>
  );
};
```

### 3. 主题管理

```jsx
// context/Theme/index.js
export const ThemeContext = createContext();

export const ThemeProvider = ({ children }) => {
  const [theme, setTheme] = useState(() => {
    return localStorage.getItem('theme') || 'light';
  });

  const toggleTheme = () => {
    const newTheme = theme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
    localStorage.setItem('theme', newTheme);
    document.body.setAttribute('theme-mode', newTheme);
  };

  useEffect(() => {
    document.body.setAttribute('theme-mode', theme);
  }, [theme]);

  return (
    <ThemeContext.Provider value={[theme, toggleTheme]}>
      {children}
    </ThemeContext.Provider>
  );
};
```

## 组件设计模式

### 1. 表格组件架构

表格组件采用模块化设计，分为多个子组件：

```
ChannelsTable (主组件)
├── ChannelsColumnDefs (列定义)
├── ChannelsActions (操作按钮)
├── ChannelsFilters (过滤器)
├── ChannelsTabs (标签页)
└── modals/ (模态框)
    ├── EditChannelModal
    ├── ModelSelectModal
    ├── ModelTestModal
    └── ...
```

#### 示例：频道表格

```jsx
// components/table/channels/ChannelsTable.jsx
function ChannelsTable() {
  const [channels, setChannels] = useState([]);
  const [loading, setLoading] = useState(true);
  const [pagination, setPagination] = useState({
    currentPage: 1,
    pageSize: 10,
    total: 0,
  });

  // 加载数据
  const loadChannels = async () => {
    setLoading(true);
    try {
      const res = await API.get('/api/channel/', {
        params: {
          p: pagination.currentPage - 1,
          size: pagination.pageSize,
        },
      });
      setChannels(res.data.data);
      setPagination({
        ...pagination,
        total: res.data.total,
      });
    } catch (error) {
      showError('加载频道失败');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadChannels();
  }, [pagination.currentPage, pagination.pageSize]);

  return (
    <div>
      <ChannelsActions onRefresh={loadChannels} />
      <ChannelsTabs />
      <ChannelsFilters />
      <Table
        columns={ChannelsColumnDefs}
        dataSource={channels}
        loading={loading}
        pagination={{
          currentPage: pagination.currentPage,
          pageSize: pagination.pageSize,
          total: pagination.total,
          onPageChange: (page) => setPagination({ ...pagination, currentPage: page }),
        }}
      />
    </div>
  );
}
```

### 2. 模态框组件

```jsx
// components/table/channels/modals/EditChannelModal.jsx
function EditChannelModal({ visible, channel, onClose, onSuccess }) {
  const [form, setForm] = useState({
    name: '',
    type: 1,
    key: '',
    models: '',
    ...channel,
  });

  const handleSubmit = async () => {
    try {
      if (channel?.id) {
        // 编辑
        await API.put(`/api/channel/${channel.id}`, form);
        showSuccess('更新成功');
      } else {
        // 新建
        await API.post('/api/channel/', form);
        showSuccess('创建成功');
      }
      onSuccess();
      onClose();
    } catch (error) {
      showError(error.message);
    }
  };

  return (
    <Modal
      visible={visible}
      onCancel={onClose}
      onOk={handleSubmit}
      title={channel?.id ? '编辑频道' : '新建频道'}
    >
      <Form>
        <Form.Input
          field="name"
          label="名称"
          value={form.name}
          onChange={(value) => setForm({ ...form, name: value })}
        />
        <Form.Select
          field="type"
          label="类型"
          value={form.type}
          onChange={(value) => setForm({ ...form, type: value })}
          optionList={CHANNEL_OPTIONS}
        />
        {/* 更多表单字段 */}
      </Form>
    </Modal>
  );
}
```

### 3. 列定义组件

```jsx
// components/table/channels/ChannelsColumnDefs.jsx
export const ChannelsColumnDefs = [
  {
    title: 'ID',
    dataIndex: 'id',
    width: 80,
  },
  {
    title: '名称',
    dataIndex: 'name',
    render: (text, record) => (
      <div>
        <div>{text}</div>
        {record.tag && <Tag>{record.tag}</Tag>}
      </div>
    ),
  },
  {
    title: '类型',
    dataIndex: 'type',
    render: (type) => CHANNEL_TYPE_MAP[type] || '未知',
  },
  {
    title: '状态',
    dataIndex: 'status',
    render: (status) => (
      <Tag color={status === 1 ? 'green' : 'red'}>
        {status === 1 ? '启用' : '禁用'}
      </Tag>
    ),
  },
  {
    title: '响应时间',
    dataIndex: 'response_time',
    render: (time) => time ? `${time}ms` : '-',
  },
  {
    title: '操作',
    dataIndex: 'actions',
    render: (_, record) => (
      <Space>
        <Button onClick={() => handleEdit(record)}>编辑</Button>
        <Button onClick={() => handleTest(record)}>测试</Button>
        <Button onClick={() => handleDelete(record)} type="danger">删除</Button>
      </Space>
    ),
  },
];
```

## API 服务封装

### 1. HTTP 请求封装

```jsx
// service/request.js
import axios from 'axios';

const request = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || '',
  timeout: 30000,
});

// 请求拦截器
request.interceptors.request.use(
  (config) => {
    // 添加认证令牌
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (user.access_token) {
      config.headers['Authorization'] = `Bearer ${user.access_token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// 响应拦截器
request.interceptors.response.use(
  (response) => {
    return response;
  },
  (error) => {
    if (error.response?.status === 401) {
      // 未授权，跳转登录
      localStorage.removeItem('user');
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);

export default request;
```

### 2. API 服务

```jsx
// service/api.js
import request from './request';

const API = {
  // 用户相关
  login: (data) => request.post('/api/user/login', data),
  register: (data) => request.post('/api/user/register', data),
  logout: () => request.get('/api/user/logout'),
  getSelf: () => request.get('/api/user/self'),

  // 频道相关
  getChannels: (params) => request.get('/api/channel/', { params }),
  getChannel: (id) => request.get(`/api/channel/${id}`),
  createChannel: (data) => request.post('/api/channel/', data),
  updateChannel: (id, data) => request.put(`/api/channel/${id}`, data),
  deleteChannel: (id) => request.delete(`/api/channel/${id}`),
  testChannel: (id) => request.get(`/api/channel/test/${id}`),

  // 令牌相关
  getTokens: (params) => request.get('/api/token/', { params }),
  createToken: (data) => request.post('/api/token/', data),
  updateToken: (id, data) => request.put(`/api/token/${id}`, data),
  deleteToken: (id) => request.delete(`/api/token/${id}`),

  // 日志相关
  getLogs: (params) => request.get('/api/log/', { params }),
  getLogStat: (params) => request.get('/api/log/stat', { params }),

  // 系统相关
  getStatus: () => request.get('/api/status'),
  getOptions: () => request.get('/api/option/'),
  updateOption: (key, value) => request.put('/api/option/', { key, value }),
};

export default API;
```

## 国际化系统

### 1. i18n 配置

```jsx
// i18n/index.js
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import LanguageDetector from 'i18next-browser-languagedetector';

import zh from './locales/zh.json';
import en from './locales/en.json';
import fr from './locales/fr.json';
import ru from './locales/ru.json';
import ja from './locales/ja.json';
import vi from './locales/vi.json';

i18n
  .use(LanguageDetector)
  .use(initReactI18next)
  .init({
    resources: {
      zh: { translation: zh },
      en: { translation: en },
      fr: { translation: fr },
      ru: { translation: ru },
      ja: { translation: ja },
      vi: { translation: vi },
    },
    fallbackLng: 'zh',
    interpolation: {
      escapeValue: false,
    },
  });

export default i18n;
```

### 2. 翻译文件结构

```json
// i18n/locales/zh.json
{
  "登录": "登录",
  "注册": "注册",
  "用户名": "用户名",
  "密码": "密码",
  "频道管理": "频道管理",
  "令牌管理": "令牌管理",
  "创建成功": "创建成功",
  "更新成功": "更新成功",
  "删除成功": "删除成功"
}
```

```json
// i18n/locales/en.json
{
  "登录": "Login",
  "注册": "Register",
  "用户名": "Username",
  "密码": "Password",
  "频道管理": "Channel Management",
  "令牌管理": "Token Management",
  "创建成功": "Created successfully",
  "更新成功": "Updated successfully",
  "删除成功": "Deleted successfully"
}
```

### 3. 使用翻译

```jsx
import { useTranslation } from 'react-i18next';

function MyComponent() {
  const { t, i18n } = useTranslation();

  const changeLanguage = (lng) => {
    i18n.changeLanguage(lng);
  };

  return (
    <div>
      <h1>{t('频道管理')}</h1>
      <Button onClick={() => changeLanguage('en')}>English</Button>
      <Button onClick={() => changeLanguage('zh')}>中文</Button>
    </div>
  );
}
```

## 主题系统

### 1. Semi Design 主题配置

```jsx
// index.jsx
import { LocaleProvider } from '@douyinfe/semi-ui';
import zh_CN from '@douyinfe/semi-ui/lib/es/locale/source/zh_CN';
import en_US from '@douyinfe/semi-ui/lib/es/locale/source/en_US';

function App() {
  const [locale, setLocale] = useState(zh_CN);

  return (
    <LocaleProvider locale={locale}>
      {/* 应用内容 */}
    </LocaleProvider>
  );
}
```

### 2. 自定义主题

```css
/* index.css */
:root {
  --semi-color-primary: #1890ff;
  --semi-color-success: #52c41a;
  --semi-color-warning: #faad14;
  --semi-color-danger: #f5222d;
}

[theme-mode='dark'] {
  --semi-color-bg-0: #1a1a1a;
  --semi-color-bg-1: #2a2a2a;
  --semi-color-text-0: #ffffff;
  --semi-color-text-1: #e0e0e0;
}
```

## 性能优化

### 1. 代码分割

```jsx
// App.jsx
import { lazy, Suspense } from 'react';

const Home = lazy(() => import('./pages/Home'));
const Dashboard = lazy(() => import('./pages/Dashboard'));

function App() {
  return (
    <Suspense fallback={<Loading />}>
      <Routes>
        <Route path="/" element={<Home />} />
        <Route path="/console" element={<Dashboard />} />
      </Routes>
    </Suspense>
  );
}
```

### 2. 虚拟滚动

对于大数据量表格，使用虚拟滚动：

```jsx
import { VirtualTable } from '@douyinfe/semi-ui';

function LargeTable() {
  return (
    <VirtualTable
      columns={columns}
      dataSource={largeDataSource}
      scroll={{ y: 600 }}
    />
  );
}
```

### 3. 防抖和节流

```jsx
import { debounce } from 'lodash';

function SearchInput() {
  const handleSearch = debounce((value) => {
    // 搜索逻辑
  }, 300);

  return <Input onChange={handleSearch} />;
}
```

## 构建和部署

### 1. 开发环境

```bash
# 使用 Bun
bun install
bun run dev

# 使用 npm
npm install
npm run dev
```

### 2. 生产构建

```bash
# 使用 Bun
bun run build

# 使用 npm
npm run build
```

### 3. Vite 配置

```js
// vite.config.js
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:3001',
        changeOrigin: true,
      },
    },
  },
  build: {
    outDir: 'dist',
    sourcemap: false,
    rollupOptions: {
      output: {
        manualChunks: {
          'react-vendor': ['react', 'react-dom', 'react-router-dom'],
          'semi-ui': ['@douyinfe/semi-ui'],
        },
      },
    },
  },
});
```

## 下一步阅读

- [05-前端组件开发指南.md](./05-前端组件开发指南.md) - 组件开发最佳实践
- [06-前端状态管理.md](./06-前端状态管理.md) - 状态管理详解
- [07-前端API集成.md](./07-前端API集成.md) - API 集成指南
