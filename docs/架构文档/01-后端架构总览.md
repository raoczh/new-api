# New API 后端架构总览

## 项目简介

New API 是一个基于 Go 语言开发的 AI API 网关/代理系统，聚合了 40+ 个上游 AI 提供商（OpenAI、Claude、Gemini、Azure、AWS Bedrock 等），提供统一的 API 接口，并具备用户管理、计费、速率限制和管理后台等功能。

## 技术栈

- **语言**: Go 1.22+
- **Web 框架**: Gin
- **ORM**: GORM v2
- **数据库**: SQLite / MySQL / PostgreSQL（三者必须同时支持）
- **缓存**: Redis (go-redis) + 内存缓存
- **认证**: JWT、WebAuthn/Passkeys、OAuth (GitHub、Discord、OIDC 等)
- **国际化**: go-i18n (后端)、i18next (前端)

## 核心架构设计

### 1. 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                         HTTP 请求                            │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    Router 层 (路由分发)                       │
│  - API Router (用户、频道、令牌等管理接口)                     │
│  - Relay Router (AI API 中继接口)                            │
│  - Dashboard Router (仪表板接口)                             │
│  - Web Router (前端静态资源)                                  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                   Middleware 层 (中间件)                      │
│  - Auth (认证)                                               │
│  - Rate Limit (速率限制)                                      │
│  - Distributor (渠道分发)                                     │
│  - CORS、Logger、I18n、Cache 等                              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                  Controller 层 (请求处理)                     │
│  - 53 个控制器处理各类业务请求                                 │
│  - 参数验证、权限检查、业务编排                                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                   Service 层 (业务逻辑)                       │
│  - 45 个服务模块                                              │
│  - 请求转换、配额管理、文件处理、计费等                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    Model 层 (数据访问)                        │
│  - 33 个数据模型                                              │
│  - GORM 数据库操作、缓存管理                                   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                  Database (数据持久化)                        │
│  - SQLite / MySQL / PostgreSQL                              │
│  - Redis (可选)                                              │
└─────────────────────────────────────────────────────────────┘
```

### 2. AI 中继系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      客户端请求                               │
│              (OpenAI 格式 / Claude 格式等)                    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                   Relay Router (中继路由)                     │
│  - /v1/chat/completions                                     │
│  - /v1/messages (Claude)                                    │
│  - /v1beta/models/* (Gemini)                                │
│  - /v1/audio/*, /v1/images/*, /v1/embeddings 等             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│              Distributor Middleware (渠道分发)                │
│  1. 解析请求模型                                              │
│  2. 检查令牌权限和模型限制                                     │
│  3. 根据分组、权重、亲和性选择可用渠道                          │
│  4. 设置渠道上下文信息                                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                Channel Adaptor (渠道适配器)                   │
│  - 39 个提供商适配器                                          │
│  - 请求格式转换 (OpenAI ↔ Claude ↔ Gemini 等)                │
│  - 响应格式转换                                               │
│  - 流式响应处理                                               │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                  上游 AI 提供商 API                           │
│  OpenAI, Claude, Gemini, Azure, AWS, 百度, 阿里, 腾讯...     │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    响应处理与计费                             │
│  - Token 计数                                                │
│  - 配额扣除                                                   │
│  - 日志记录                                                   │
│  - 渠道亲和性记录                                             │
└─────────────────────────────────────────────────────────────┘
```

## 目录结构详解

### 核心目录

```
new-api/
├── main.go                    # 应用入口
├── router/                    # 路由定义 (6 个文件)
│   ├── main.go               # 路由主入口
│   ├── api-router.go         # 管理 API 路由
│   ├── relay-router.go       # AI 中继路由
│   ├── dashboard.go          # 仪表板路由
│   ├── web-router.go         # 前端路由
│   └── video-router.go       # 视频路由
│
├── middleware/               # 中间件 (21 个文件)
│   ├── auth.go              # JWT 认证
│   ├── distributor.go       # 渠道分发核心
│   ├── rate-limit.go        # 速率限制
│   ├── model-rate-limit.go  # 模型级速率限制
│   ├── cors.go              # 跨域处理
│   ├── logger.go            # 日志记录
│   ├── i18n.go              # 国际化
│   └── ...
│
├── controller/              # 控制器 (53 个文件)
│   ├── user.go             # 用户管理
│   ├── channel.go          # 频道管理
│   ├── token.go            # 令牌管理
│   ├── model.go            # 模型管理
│   ├── billing.go          # 账单管理
│   ├── subscription.go     # 订阅管理
│   ├── log.go              # 日志查询
│   └── ...
│
├── service/                # 业务逻辑 (45 个文件)
│   ├── convert.go          # 请求/响应转换
│   ├── quota.go            # 配额管理
│   ├── channel_affinity.go # 渠道亲和性
│   ├── token_counter.go    # Token 计数
│   ├── billing_session.go  # 计费会话
│   ├── file_service.go     # 文件处理
│   └── ...
│
├── model/                  # 数据模型 (33 个文件)
│   ├── main.go            # 数据库初始化
│   ├── user.go            # 用户模型
│   ├── channel.go         # 频道模型
│   ├── token.go           # 令牌模型
│   ├── log.go             # 日志模型
│   ├── subscription.go    # 订阅模型
│   └── ...
│
├── relay/                 # AI 中继系统 (177 个文件)
│   ├── channel/           # 提供商适配器 (39 个)
│   │   ├── openai/       # OpenAI 适配器
│   │   ├── claude/       # Claude 适配器
│   │   ├── gemini/       # Gemini 适配器
│   │   ├── aws/          # AWS Bedrock
│   │   ├── azure/        # Azure OpenAI
│   │   ├── baidu/        # 百度文心
│   │   ├── ali/          # 阿里通义
│   │   └── ...
│   ├── common/           # 通用处理
│   ├── helper/           # 辅助函数
│   └── constant/         # 中继常量
│
├── setting/              # 配置管理 (42 个文件)
│   ├── ratio_setting/    # 比率配置
│   ├── model_setting/    # 模型设置
│   ├── system_setting/   # 系统设置
│   ├── operation_setting/# 操作设置
│   └── performance_setting/ # 性能设置
│
├── common/               # 通用工具 (45 个文件)
│   ├── json.go          # JSON 处理 (必须使用)
│   ├── database.go      # 数据库工具
│   ├── redis.go         # Redis 客户端
│   ├── crypto.go        # 加密工具
│   ├── email.go         # 邮件发送
│   └── ...
│
├── constant/            # 常量定义 (12 个文件)
│   ├── channel.go      # 频道类型 (57 个提供商)
│   ├── api_type.go     # API 类型
│   └── ...
│
├── dto/                # 数据传输对象 (26 个文件)
├── types/              # 类型定义 (9 个文件)
├── oauth/              # OAuth 认证 (8 个文件)
├── pkg/                # 内部包 (9 个文件)
└── i18n/               # 国际化 (2 个文件)
```

## 启动流程

### main.go 启动顺序

```go
1. InitResources() - 初始化资源
   ├── 加载 .env 环境变量
   ├── 初始化环境变量 (common.InitEnv)
   ├── 设置日志系统 (logger.SetupLogger)
   ├── 初始化比率设置 (ratio_setting.InitRatioSettings)
   ├── 初始化 HTTP 客户端 (service.InitHttpClient)
   ├── 初始化 Token 编码器 (service.InitTokenEncoders)
   ├── 初始化数据库 (model.InitDB)
   ├── 检查系统设置 (model.CheckSetup)
   ├── 初始化配置选项 (model.InitOptionMap)
   ├── 清理旧缓存文件 (common.CleanupOldCacheFiles)
   ├── 获取定价信息 (model.GetPricing)
   ├── 初始化日志数据库 (model.InitLogDB)
   ├── 初始化 Redis (common.InitRedisClient)
   ├── 启动系统监控 (common.StartSystemMonitor)
   ├── 初始化国际化 (i18n.Init)
   └── 加载自定义 OAuth 提供商 (oauth.LoadCustomProviders)

2. 初始化缓存系统
   ├── 初始化渠道缓存 (model.InitChannelCache)
   └── 启动缓存同步 (model.SyncChannelCache)

3. 启动后台任务
   ├── 同步配置选项 (model.SyncOptions)
   ├── 更新配额数据 (model.UpdateQuotaData)
   ├── 自动更新渠道 (controller.AutomaticallyUpdateChannels)
   ├── 自动测试渠道 (controller.AutomaticallyTestChannels)
   ├── Codex 凭证自动刷新 (service.StartCodexCredentialAutoRefreshTask)
   ├── 订阅配额重置任务 (service.StartSubscriptionQuotaResetTask)
   ├── 更新 Midjourney 任务 (controller.UpdateMidjourneyTaskBulk)
   └── 更新通用任务 (controller.UpdateTaskBulk)

4. 初始化 Gin 服务器
   ├── 创建 Gin 引擎
   ├── 注册中间件 (Recovery, RequestId, PoweredBy, I18n, Logger, Session)
   ├── 设置路由 (router.SetRouter)
   └── 启动 HTTP 服务器 (默认端口 3000)
```

## 核心功能模块

### 1. 用户管理系统
- 用户注册、登录、密码重置
- 多种 OAuth 登录（GitHub、Discord、OIDC、LinuxDO 等）
- WebAuthn/Passkeys 无密码登录
- 双因素认证 (2FA)
- 用户分组和权限管理
- 邀请码系统

### 2. 令牌管理系统
- 令牌创建、编辑、删除
- 令牌配额管理（有限/无限）
- 模型访问限制
- IP 白名单限制
- 令牌过期时间设置
- 跨分组重试功能

### 3. 渠道管理系统
- 39+ AI 提供商支持
- 渠道启用/禁用
- 多 Key 管理（轮询/随机模式）
- 渠道权重配置
- 渠道优先级
- 自动禁用机制
- 模型映射
- 状态码映射
- 参数覆盖
- 请求头覆盖

### 4. 计费系统
- Token 计数（输入/输出分别计费）
- 模型定价管理
- 配额扣除
- 充值管理
- 订阅计划
- 兑换码系统
- 计费会话管理

### 5. 日志系统
- 使用日志记录
- 任务日志
- Midjourney 日志
- 日志查询和过滤
- 日志导出

### 6. 监控系统
- 渠道响应时间监控
- 渠道余额监控
- 系统资源监控
- 配额数据统计
- 仪表板数据展示

## 数据库设计原则

### 多数据库兼容性

系统必须同时支持 SQLite、MySQL (≥5.7.8)、PostgreSQL (≥9.6)：

1. **使用 GORM 抽象层**
   - 优先使用 GORM 方法而非原生 SQL
   - 让 GORM 处理主键生成

2. **原生 SQL 注意事项**
   - 列引号：PostgreSQL 用 `"column"`，MySQL/SQLite 用 `` `column` ``
   - 布尔值：PostgreSQL 用 `true`/`false`，MySQL/SQLite 用 `1`/`0`
   - 使用 `commonGroupCol`、`commonKeyCol`、`commonTrueVal`、`commonFalseVal` 变量

3. **禁止的操作**
   - MySQL 独有函数（如 `GROUP_CONCAT`）需提供 PostgreSQL 等效实现
   - PostgreSQL 独有操作符（如 `@>`、`?`、`JSONB`）
   - SQLite 不支持 `ALTER COLUMN`（使用 `ADD COLUMN` 替代）

## 关键设计模式

### 1. JSON 处理规范

**必须使用 `common/json.go` 中的包装函数：**

```go
// 正确 ✓
data, err := common.Marshal(obj)
err := common.Unmarshal(data, &obj)

// 错误 ✗
data, err := json.Marshal(obj)
err := json.Unmarshal(data, &obj)
```

### 2. 渠道分发策略

```
1. 检查令牌是否指定特定渠道
2. 检查令牌模型限制
3. 检查渠道亲和性（优先使用最近成功的渠道）
4. 根据分组、模型、权重随机选择可用渠道
5. 设置渠道上下文信息
6. 执行请求
7. 记录渠道亲和性（成功时）
```

### 3. 请求重试机制

```
1. 请求失败时检查错误类型
2. 如果是可重试错误（如 429、503）
3. 排除当前失败的渠道
4. 重新选择可用渠道
5. 重试请求（最多 3 次）
```

### 4. 缓存策略

- **渠道缓存**: 内存缓存 + 定期同步（默认 60 秒）
- **配置缓存**: 内存缓存 + 定期同步
- **Redis 缓存**: 可选，用于分布式部署
- **磁盘缓存**: 用于文件存储

## 性能优化

1. **数据库连接池**
   - MaxIdleConns: 100
   - MaxOpenConns: 1000
   - ConnMaxLifetime: 60 秒

2. **批量更新**
   - 可选启用批量更新模式
   - 减少数据库写入频率

3. **并发处理**
   - 使用 gopool 进行并发任务处理
   - 渠道测试并发执行

4. **流式响应**
   - SSE (Server-Sent Events) 支持
   - 实时 Token 流式传输

## 安全机制

1. **认证**
   - JWT Token 认证
   - Session 管理
   - OAuth 第三方登录

2. **授权**
   - 基于角色的访问控制 (RBAC)
   - 令牌权限控制
   - IP 白名单

3. **速率限制**
   - 全局速率限制
   - 用户级速率限制
   - 模型级速率限制

4. **数据安全**
   - 密码哈希存储
   - 敏感信息加密
   - SQL 注入防护

## 国际化支持

- **后端**: go-i18n (支持 en、zh)
- **前端**: i18next (支持 zh、en、fr、ru、ja、vi)
- **动态语言切换**
- **用户语言偏好保存**

## 下一步阅读

- [02-数据库模型设计.md](./02-数据库模型设计.md) - 详细的数据库表结构
- [03-AI中继系统详解.md](./03-AI中继系统详解.md) - AI API 中继核心原理
- [04-渠道适配器开发.md](./04-渠道适配器开发.md) - 如何添加新的 AI 提供商
- [05-中间件系统.md](./05-中间件系统.md) - 中间件工作原理
- [06-计费系统.md](./06-计费系统.md) - 计费和配额管理
